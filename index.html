<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Your New Congressional District in 2012</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Did your congressional district change? Get a quick answer.">
    <meta name="author" content="Civic Impulse LLC">

    <!-- Le styles -->
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
        font-family: Arial, sans-serif;
        font-size: 16px;
      }
      
      a {
          color: #939;
      }
      
      .hero-unit {
      	  margin-toptter bo: 20px;
      }
      .hero-unit h1 {
      	  display: none; /* huh, it's simpler without an h1 */
      }
      
      .gutter {
      	  border-left: 1px solid #CCC;
      	  padding-left: 2em;
      }
      
      p {
        line-height: 140%;
      }
      
      .row.results {
          margin-top: 1.5em;
          border-top: 1px solid #CCC;
          padding-top: 1.5em;
      }
        .row.results.number {
            border: none;
        }
        .row.results h2 {
            line-height: 130%;
        }
        .row.results h2 i {
            display: block;
        }
      
      .your_district {
      	  padding: .66em .33em .66em .33em;
      	  background-color: #EEE;
      	  border: 1px solid #F3F3F3;
      	  text-align: center;
      }
      .your_district div.large {
          margin-top: .5em;
      	  font-family: Verdana, Arial, sans-serif;
      	  font-size: 22px;
      	  font-weight: bold;
      }
      
      .results.candidates .old p.name {
      	  margin-top: 1em;
      	  font-weight: bold;
      	  text-align: center;
      }
      	.results.candidates .old p.name a {
      		color: #303;
      		text-decoration: underline;
      	}
      .results.candidates .old img.name {
      	  display: block;
      	  width: 100px;
      	  margin: 10px auto 2em auto;
      	  border: 1px solid black;
      }
      
      .maps p {
      	  padding: 0 0 1.5em 0;
      }
      
      .candidate {
      	  margin: 2em 0 0 1em;
      }
      .candidate .party {
      	  margin: 5px 0 5px 0;
      	  font-size: 95%;
      	  font-style: italic;
      	  color: #444;
      }
      .candidate .name a {
      	  font-size: 105%;
      	  font-weight: bold;
      	  color: #303;
      }
      	.candidate.party_d .name a { color: #0041a1; }
      	.candidate.party_r .name a { color: #e60e13; }
      .candidate .status {
      	  margin-top: 3px;
      	  margin-left: 2px;
      	  border-left: 1px solid #555;
      	  padding-left: 5px;
      }
      .candidate .status.important {
      	  border-left: 2px solid black;
      }
      
      .notes {
      	  font-size: 85%;
      	  color: #777;
      }
      
      footer {
      	  padding-top: 3em;
      	  font-size: 75%;
      	  color: #888;
      }
    </style>
    <link href="/static/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  </head>
  
  <script>
  var geocoder_result;
  var old_district = null;
  var new_district = null;
  
  function go(newaddr) {
  	    var addr = $('#address').val();
  	  
  	    if (newaddr) {
  	    	$('#address').val(newaddr);
  	    	addr = newaddr;
  	    }
  	    
  	    if (addr == "") {
  	    	$('.intro-only').fadeIn();
  	    	return;
  	    }
  
  	    old_district = null;
  	    new_district = null;
  	    geocoder_result = null;
  	    
  	    if (/^[a-zA-Z][a-zA-Z]-\d\d?$/.test(addr)) {
		    var state = addr.split("-")[0].toLowerCase();
		    var distr = addr.split("-")[1];
		    if (distr.length == 1) distr = "0" + distr;
  	    	
  	    	load_old_data({ external_id: state + "-" + distr }, true);
  	    	load_new_data({ external_id: state + "-" + distr }, true);
  	    	return;
  	    }
  	    
		var geocoder = new google.maps.Geocoder();
		$('#gobtn').text("Loading...").addClass("disabled");
		geocoder.geocode(
			{ 'address': addr },
			function(results, status) {
				$('#gobtn').text("Next »").removeClass("disabled");
				
				if (status != google.maps.GeocoderStatus.OK) {
					$('.hero-unit .error').text("I didn't understand that address.").fadeIn();
					$('.results').hide();
					return;
				}
					
				districts = { };
				
				geocoder_result = results[0].geometry.location;
				
				for (var i = 0; i < results[0].address_components.length; i++) {
					var ac = results[0].address_components[i];
					if (ac.types[0] == "administrative_area_level_1" && ac.short_name == "RI") {
						$('.hero-unit .error').text("Sorry, Rhode Island hasn't made available detailed geographic information for its 2012 districts yet.").fadeIn();
						$('.results').hide();
						return;
					}
				}

				function load_district(layer, callback) {
					$.ajax(
						"/boundaries/" + layer + "/?contains=" + geocoder_result.lat() + "," + geocoder_result.lng(),
						{
							success: function(res) {
								if (res.objects.length > 0)
									callback(res.objects[0]);
								else
									callback("NONE");
							}
						}
					);
				}
				
				load_district("2010-cd", load_old_data);
				load_district("2012-cd", load_new_data);
			});
	
  }
  
  function load_old_data(rec, artificial) {
  	  if (rec == "NONE") {
  	  	  $('.results').hide();
		  $('.hero-unit .error').text("That location does not seem to be located in a United States Congressional District.").fadeIn();
		  return;
  	  }
  	  
  	  $('.results.number .old .text').text(
  	  	  !artificial ? "In 2010 you voted in..."
  	  	  : "In the old...");
  	  
  	  old_district = rec.external_id;
  	  
	  var state = rec.external_id.split("-")[0];
	  var distr = rec.external_id.split("-")[1]; // don't do parseInt if value has leading zeroes
	  
	  $(".results.number .old .dist-num").text(distr);
	  $(".results.number .old .dist-state").text(state.toUpperCase());
	  
	  var container = $(".results.candidates .old");
	  container.text('');
	  
	  $.ajax("/static/districts/olddistrict_" + old_district.replace("-", "") + ".json",
		{
			success: function(res) {
				if (!res.REP) {
					container.append($('<p>It seems like your district&rsquo;s House office is currently vacant.</p>'));
					return;
				}
				
				container.append($("<p>You are still represented by...</p>"));
				
				var n = $('<p class="name"><a> </a></p>');
				n.find('a').attr('href', res.REP.link).text(res.REP.name);
				container.append(n);
				
				container.append($('<img class="name" width="100" height="125"/>').attr('src', '/static/rep_photos/' + res.REP.id + '-100px.jpeg'));
				container.append($('<p>...until the new Members of Congress take office in January.</p>'));
				
				if (res.STATUS) {
					container.append($('<p></p>').text(res.REP.lastname + " is not on the ballot in 2012 because " + (res.REP.gender == "male" ? "he" : "she") + " " + res.STATUS + "."));
				}
			}
		});
	  
  
  	  show_results();
  }
  
  function load_new_data(rec, artificial) {
  	  if (old_district && rec == "NONE") {
  	  	  $('.results').hide();
		  $('.hero-unit .error').text("We are missing information on that location.").fadeIn();
		  return;
  	  }
  	  
  	  $('.results.number .new .text').text(
  	  	  !artificial ? "You’ll vote this November in..."
  	  	  : "Here is the new...");

  	  new_district = rec.external_id;
  	  
	  var state = rec.external_id.split("-")[0];
	  var distr = rec.external_id.split("-")[1]; // don't do parseInt if value has leading zeroes
	  
	  $(".results.number .new .dist-num").text(distr);
	  $(".results.number .new .dist-state").text(state.toUpperCase());

	  var container = $('.results.candidates .new');
	  container.text('');
	  
	  $.ajax("/static/districts/candidates_" + new_district.replace("-", "") + ".json",
		{
			success: function(res) {
				if (res.length == 0) {
					container.append($('<p/>').text("We don't have any information on candidates running for office in this district."));
					return;
				}
				
				container.append($('<p/>').text("These " + res.length + " candidates want to be your representative in 2013-2014:"));
				
				var incumbent_count = 0;
				for (var i = 0; i < res.length; i++) {
					var can = res[i];
					var n = $('<div class="candidate"><div class="name"><a/></div><div class="party"/><div class="status"/></div>');
					
					if (can.GOVTRACK_INFO)
						n.find('.name a').attr('href', can.GOVTRACK_INFO.link).text(can.GOVTRACK_INFO.name);
					else if (can.CRP_ID && can.RAN2010 && can.RAN2010.WON)
						n.find('.name a').attr('href',
							'http://www.opensecrets.org/politicians/summary.php?cycle=2012&cid=' + can.CRP_ID).text(can.NAME);
					else
						n.find('.name a').attr('href',
							'http://www.opensecrets.org/races/summary.php?cycle=2012&id=' + new_district.replace("-", "").toUpperCase()).text(can.NAME);

					n.find('.party').text(can.PARTY);
					
					if (can.PARTY == "Democratic Party") n.addClass("party_d")
					if (can.PARTY == "Republican Party") n.addClass("party_r")
					
					if (can.RAN2010) {
						if (can.RAN2010.WON) {
							var votepct = "";
							if (can.RAN2010.VOTESPCT) {
								votepct = " --- Won in 2010 with " + Math.round(can.RAN2010.VOTESPCT) + "% of the vote.";
							}
							
							if (can.RAN2010.DISTRICT == old_district.replace("-", "").toUpperCase()) {
								if (old_district == new_district) {
									n.find('.status').addClass('incumbent').text("Incumbent" + votepct);
								} else {
									n.find('.status').addClass('incumbent').addClass('important').text("Currently serving as your representative.");
								}
							} else {
								n.find('.status').addClass('incumbent').addClass('important').text("This is the incumbent in your new district." + votepct);
							}
							incumbent_count++;
						} else if (can.GOVTRACK_INFO) {
							n.find('.status').addClass('returning').text("Previously served in Congress.");
						} else {
							var votepct = "";
							if (can.RAN2010.VOTESPCT) {
								votepct = ", who lost in 2010 with " + Math.round(can.RAN2010.VOTESPCT) + "% of the vote.";
							}
							
							if (can.RAN2010.DISTRICT == old_district.replace("-", "").toUpperCase()) {
								n.find('.status').addClass('returning').text("Returning challenger in your district from 2010." + votepct);
							} else {
								n.find('.status').addClass('returning').text("Ran in " + can.RAN2010.DISTRICT + " in 2010." + votepct);
							}
						}
					} else {
						n.find('.status').addClass('challenger').text("New Challenger");
					}
					
					container.append(n);	
				}
				
				if (incumbent_count > 1) {
					container.find(".incumbent").text("Multiple districts were combined into this one and the incumbent representatives are challenging each other for the seat!");
				}
					
			}
		});
	  
	  
  	  show_results();
  }
  
  function show_results(distrid) {
	  if (!old_district || !new_district) return;
	  $('.hero-unit .error').hide();
  	  $('.intro-only').hide();
  	  $('.results').show();
  	  $(window).scrollTop($('.results').offset().top - 200);

  	  var oldmap = make_map("old", "2010-cd/" + old_district, "Here is what your old 2010 district looked like:");
	  var newmap = make_map("new", "2012-cd/" + new_district, "Here is what your new 2012 district looks like:");
	  
	  //google.maps.event.addListener(oldmap, 'dragend', function() { newmap.fitBounds(oldmap.getBounds()); });
      //google.maps.event.addListener(newmap, 'dragend', function() { oldmap.fitBounds(newmap.getBounds()); });

	  window.location.hash = "#" + $('#address').val().replace(/ +/g, "+");
  }
  
  function make_map(clz, src, descr) {
      
	// Create a map.
	var myOptions = {
		zoom: 4,
		center: geocoder_result ? geocoder_result : new google.maps.LatLng(38, -96),
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		panControl: false,
		zoomControl: true,
		mapTypeControl: true,
		scaleControl: true,
		streetViewControl: false
		};
		
	var node = $('.' + clz + ' .map_container');
	node.css({ width: node.width(), height: "320px"});
	var map = new google.maps.Map(node[0], myOptions);
	
	$('.maps .' + clz + ' p').text(descr);
	
	// Add a tile overlay for this layer.
	var overlay = new google.maps.ImageMapType({
	  getTileUrl: function(coord, zoom) {
		  return "/map/tiles/" + src + "/" + (zoom-1) + "/" + coord.x + "/" + coord.y + ".png?size=512";
	  },
	  tileSize: new google.maps.Size(512, 512),
	  isPng: true,
	  minZoom: 3,
	  maxZoom: 28,
	  opacity: .85
	});
	map.overlayMapTypes.insertAt(0, overlay);

	$.ajax("/boundaries/" + src + "/",
		{
			success: function(res) {
				if (res && res.extent) {
					var b = new google.maps.LatLngBounds(new google.maps.LatLng(res.extent[1], res.extent[0]), new google.maps.LatLng(res.extent[3], res.extent[2]));
					map.fitBounds(b);
					if (geocoder_result) map.setCenter(geocoder_result); // once the right zoom is set with fitBounds, move to the address so the two maps line up
				}
			}
		});
	
	var marker = new google.maps.Marker({
		map: map, 
		position: geocoder_result
	});
	
	return map;
  }

  </script>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/">My2012District.com</a>
          <div class="nav-collapse">
            <ul class="nav">
              <!--<li class="active"><a href="#">Home</a></li>-->
              <!--<li><a href="#about" onclick="$(window).scrollTo($('#about').offset().top); return false;">About</a></li>-->
              <li><a href="http://www.govtrack.us">GovTrack.us</a></li>
              <li><a href="http://www.civicimpulse.com">Civic Impulse, LLC</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

      <!-- Main hero unit for a primary marketing message or call to action -->
      <div class="hero-unit" style="padding: 30px">
        <h1 style="text-align: center">Find My 2012 District</h1>
        <div style="margin: 0 auto 0 auto; max-width: 580px;">
        	<p class="intro-only" style="margin-bottom: 1em; margin-left: 2px">Let&rsquo;s find your <b>current</b> congressional district and the congressional district you&rsquo;ll be voting in this <b>November</b>.</p>
        	<p style="margin: 0"><input id="address" type="text" placeholder="enter your address and then click next" style="width: 100%; height: 36px; font: 20px/24px Verdana,Arial,sans-serif bold;"/></p>
        	<p class="error" style="display: none; color: red; font-weight: bold;"> </p>
        	<p class="try" style="font-size: 80%; margin: 0;">Try:
        		<a href="#" onclick="go($(this).text()); return false;">Des Moines, IA</a> |
        		<a href="#" onclick="go($(this).text()); return false;">Plainview, NY</a> |
        		<a href="#" onclick="go($(this).text()); return false;">Vallejo, CA</a> |
        		<a href="#" onclick="go($(this).text()); return false;">08544</a> |
        		<a href="#" onclick="go($(this).text()); return false;">CA-21</a>
        	</p>
        	<p style="text-align: right"><a id="gobtn" class="btn btn-warning btn-large" onclick="go(); return false;">Next &raquo;</a></p>
        </div>
      </div>
    
      <div class="row results number" style="display: none;">
        <div class="span2">
            <h2><i class="icon-star"></i> Your District</h2>
        </div>
        <div class="span5 new">
          <div class="your_district">
            <div class="text">You&rsquo;ll vote this November in...</div>
            <div class="large"><span class="dist-state"> </span>-<span class="dist-num"> </span></div>
          </div>
        </div>
        <div class="span5 old">
          <div class="your_district">
            <div class="text">In 2010 you voted in</div>
            <div class="large"><span class="dist-state"> </span>-<span class="dist-num"> </span></div>
          </div>
        </div>
      </div>

      <div class="row results candidates" style="display: none;">
        <div class="span2">
            <h2><i class="icon-user"></i> Who&rsquo;s Running</h2>
        </div>
        <div class="span5 new">
        </div>
        <div class="span5 old">
        </div>
      </div>

      <div class="row results maps" style="display: none;">
        <div class="span2">
            <h2><i class="icon-map-marker"></i> On A Map</h2>
        </div>
        <div class="span5 new">
          <p> </p>
          <div class="map_container"> </div>
        </div>
        <div class="span5 old">
          <p> </p>
          <div class="map_container"> </div>
        </div>
      </div>

      <div class="row results notes" style="display: none;">
        <div class="span2">
            <h2><i class="icon-exclamation-sign"></i> Notes</h2>
        </div>
        <div class="span5 new">
          <p>Your new district number is based on the best information we have available right now. Districts may still be subject to change. Check your voter registration before the election to be sure.</p>
          
          <p>Make sure you&rsquo;re ready to vote by registering to vote on <a href="https://turbovote.org/register/start">TurboVote</a>.</p>
        </div>
        <div class="span5 old">
            &nbsp;
        </div>
      </div>
      
      <footer>
        <p>A project of <a href="http://www.civicimpulse.com">Civic Impulse, LLC</a> | <a href="http://twitter.com/govtrack">@GovTrack</a> | <a href="mailto:&#111;&#112;&#101;&#114;&#097;&#116;&#105;&#111;&#110;&#115;&#064;&#103;&#111;&#118;&#116;&#114;&#097;&#099;&#107;&#046;&#117;&#115;?subject=My%202012%20District">&#111;&#112;&#101;&#114;&#097;&#116;&#105;&#111;&#110;&#115;&#064;&#103;&#111;&#118;&#116;&#114;&#097;&#099;&#107;&#046;&#117;&#115;</a>.</p>
        <p>Redistricting boundaries from the
        	<a href="http://www.srrproject.org/resources/redistricting-shapefiles/">The SRR Project</a>/Brennan Center and the 50 states. Current district boundaries from the
        	<a href="http://www.census.gov/geo/www/tiger/tgrshp2011/tgrshp2011.html">United States Census Bureau</a>. Candidate information from the
        	<a href="http://www.opensecrets.org">Center for Responsive Politics</a> and the
        	<a href="http://www.fec.gov/finance/disclosure/ftpsum.shtml">Federal Election Commission</a>.
        	Current representative information from <a href="http://www.govtrack.us">GovTrack.us</a>.
        	List of retiring/resigned/etc. representatives from <a href="http://www.rollcall.com/politics/casualtylist.html">Roll Call</a>.
        </p>
        <p>This site is created using
        	<a href="https://github.com/tauberer/represent-boundaries">represent-boundaries</a>,
        	<a href="https://github.com/tauberer/boundaries_us">boundaries_us</a>,
        	<a href="https://developers.google.com/maps/documentation/javascript/">Google Maps API</a>,
        	and <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter</a>.
		</p>
      </footer>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/static/bootstrap/js/jquery-1.7.2.min.js"></script>

    <script>
	  jQuery.fn.keydown_enter = function(callback) {
	    return this.each(function(){
		  jQuery(this).keydown(function(ev) {
		    if (ev.keyCode == '13')
			  callback();
		  });
	    });
	  }
    
	  $(function() {
		  $("#address").keydown_enter(function() { go(); });
		  if (window.location.hash != "" && window.location.hash != "#") {
			  go(window.location.hash.substr(1).replace(/\+/g, " "));
		  }
	  });
	  </script>    
  </body>
</html>

