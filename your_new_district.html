<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Your New Congressional District in 2012</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Did your congressional district change? Get a quick answer.">
    <meta name="author" content="Civic Impulse LLC">

    <!-- Le styles -->
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
        font-family: Arial, sans-serif;
        font-size: 16px;
      }
      
      .gutter {
      	  border-left: 1px solid #CCC;
      	  padding-left: 2em;
      }
      
      p {
        line-height: 140%;
      }
      
      h2 {
      	  font-size: 17px;
      	  font-weight: normal;
      }
      
      .your_district {
      	  width: 5em;
      	  margin: .75em auto .75em auto;
      	  padding: .66em .33em .66em .33em;
      	  background-color: #EEE;
      	  border: 1px solid #CCC;
      	  font-family: Verdana, Arial, sans-serif;
      	  font-size: 28px;
      	  font-weight: bold;
      	  text-align: center;
      }
      
      #left_result p.name {
      	  margin-top: 1em;
      	  font-weight: bold;
      	  text-align: center;
      }
      	#left_result p.name a {
      		color: #303;
      		text-decoration: underline;
      	}
      #left_result img.name {
      	  display: block;
      	  width: 100px;
      	  margin: 10px auto 2em auto;
      	  border: 1px solid black;
      }
      
      .maps p {
      	  padding: 2em 0 1.5em 0;
      }
      
      .candidate {
      	  margin: 2em 0 0 1em;
      }
      .candidate .party {
      	  margin: 5px 0 5px 0;
      	  font-size: 95%;
      	  font-style: italic;
      	  color: #444;
      }
      .candidate .name a {
      	  font-size: 105%;
      	  font-weight: bold;
      	  color: #303;
      }
      	.candidate.party_d .name a { color: #0041a1; }
      	.candidate.party_r .name a { color: #e60e13; }
      .candidate .status {
      	  margin-top: 3px;
      	  margin-left: 2px;
      	  border-left: 1px solid #555;
      	  padding-left: 5px;
      }
      .candidate .status.important {
      	  border-left: 2px solid black;
      }
      
      .turbovote {
      	  margin: 2em 0 2em 0;
      	  border-top: 1px solid #EEE;
      	  border-bottom: 1px solid #EEE;
      	  padding: 2em 0 2em 0;
      	  font-size: 90%;
      }
    </style>
    <link href="/static/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  </head>
  
  <script>
  var geocoder_result;
  var left_district = null;
  var right_district = null;
  
  function go(newaddr) {
  	    if (newaddr) $('#address').val(newaddr);
  	  
  	    if ($('#address').val() == "") {
  	    	$('.intro-only').fadeIn();
  	    	return;
  	    }
  
  	    left_district = null;
  	    right_district = null;
  	    
		var geocoder = new google.maps.Geocoder();
		geocoder.geocode(
			{ 'address': $('#address').val() },
			function(results, status) {
				if (status != google.maps.GeocoderStatus.OK) {
					$('.hero-unit .error').text("I didn't understand that address.").fadeIn();
					$('.results').hide();
					return;
				}
					
				districts = { };
				
				geocoder_result = results[0].geometry.location;
				
				for (var i = 0; i < results[0].address_components.length; i++) {
					var ac = results[0].address_components[i];
					if (ac.types[0] == "administrative_area_level_1" && ac.short_name == "RI") {
						$('.hero-unit .error').text("Sorry, Rhode Island hasn't made available detailed geographic information for its 2012 districts yet.").fadeIn();
						$('.results').hide();
						return;
					}
				}

				function load_district(layer, callback) {
					$.ajax(
						"/boundaries/" + layer + "/?contains=" + results[0].geometry.location.lat() + "," + results[0].geometry.location.lng(),
						{
							success: function(res) {
								if (res.objects.length > 0)
									callback(res.objects[0]);
								else
									callback("NONE");
							}
						}
					);
				}
				
				load_district("2010-cd", load_left_data);
				load_district("2012-cd", load_right_data);
			});
	
  }
  
  function load_left_data(rec) {
  	  if (rec == "NONE") {
  	  	  $('.results').hide();
		  $('.hero-unit .error').text("That location does not seem to be located in a United States Congressional District.").fadeIn();
		  return;
  	  }
  	  
  	  left_district = rec.external_id;
  	  
	  var state = rec.external_id.split("-")[0];
	  var distr = rec.external_id.split("-")[1]; // don't do parseInt if value has leading zeroes
	  
	  $("#left_result .dist-num").text(distr);
	  $("#left_result .dist-state").text(state.toUpperCase());
	  
	  $("#left_result .info").text('');
	  
	  $.ajax("/static/districts/olddistrict_" + left_district.replace("-", "") + ".json",
		{
			success: function(res) {
				if (!res.REP) {
					$('#left_result .info').append($('<p>It seems like your district&rsquo;s House office is currently vacant.</p>'));
					return;
				}
				
				$('#left_result .info').append($("<p>You are still represented by...</p>"));
				
				var n = $('<p class="name"><a> </a></p>');
				n.find('a').attr('href', res.REP.link).text(res.REP.name);
				$('#left_result .info').append(n);
				
				$('#left_result .info').append($('<img class="name"/>').attr('src', 'http://www.govtrack.us/data/photos/' + res.REP.id + '-100px.jpeg'));
				$('#left_result .info').append($('<p>...until the new Members of Congress take office in January.</p>'));
			}
		});
	  
  
  	  show_results();
  }
  
  function load_right_data(rec) {
  	  if (left_district && rec == "NONE") {
  	  	  $('.results').hide();
		  $('.hero-unit .error').text("We are missing information on that location.").fadeIn();
		  return;
  	  }
  	  
  	  right_district = rec.external_id;
  	  
	  var state = rec.external_id.split("-")[0];
	  var distr = rec.external_id.split("-")[1]; // don't do parseInt if value has leading zeroes
	  
	  $("#right_result .dist-num").text(distr);
	  $("#right_result .dist-state").text(state.toUpperCase());

	  $("#right_result .info").text('');
	  
	  $.ajax("/static/districts/candidates_" + right_district.replace("-", "") + ".json",
		{
			success: function(res) {
				if (res.length == 0) {
					$('#right_result .info').append($('<p/>').text("We don't have any information on candidates running for office in this district."));
					return;
				}
				
				$('#right_result .info').append($('<p/>').text(res.length + " candidates want to be your representative in 2013-2014:"));
				
				var incumbent_count = 0;
				for (var i = 0; i < res.length; i++) {
					var can = res[i];
					var n = $('<div class="candidate"><div class="name"><a/></div><div class="party"/><div class="status"/></div>');
					
					if (can.GOVTRACK_INFO)
						n.find('.name a').attr('href', can.GOVTRACK_INFO.link).text(can.GOVTRACK_INFO.name);
					else if (can.CRP_ID && can.RAN2010 && can.RAN2010.WON)
						n.find('.name a').attr('href',
							'http://www.opensecrets.org/politicians/summary.php?cycle=2012&cid=' + can.CRP_ID).text(can.NAME);
					else
						n.find('.name a').attr('href',
							'http://www.opensecrets.org/races/summary.php?cycle=2012&id=' + right_district.replace("-", "").toUpperCase()).text(can.NAME);

					n.find('.party').text(can.PARTY);
					
					if (can.PARTY == "Democratic Party") n.addClass("party_d")
					if (can.PARTY == "Republican Party") n.addClass("party_r")
					
					if (can.RAN2010) {
						if (can.RAN2010.WON) {
							var votepct = "";
							/*if (can.RAN2010.VOTEPCT) {
								votepct = " --- Won with " + can.RAN2010.VOTEPCT + "% of the vote.";
							}*/
							
							if (can.RAN2010.DISTRICT == left_district.replace("-", "").toUpperCase()) {
								if (left_district == right_district) {
									n.find('.status').addClass('incumbent').text("Incumbent" + votepct);
								} else {
									n.find('.status').addClass('incumbent').addClass('important').text("Although your districtâ€™s number and boundary has changed, your current representative is the incumbent in your new district.");
								}
							} else {
								n.find('.status').addClass('incumbent').addClass('important').text("This is the incumbent in your new district." + votepct);
							}
							incumbent_count++;
						} else if (can.GOVTRACK_INFO) {
							n.find('.status').addClass('returning').text("Previously served in Congress");
						} else {
							if (can.RAN2010.DISTRICT == left_district.replace("-", "").toUpperCase()) {
								n.find('.status').addClass('returning').text("Returning challenger in your district from 2010");
							} else {
								n.find('.status').addClass('returning').text("Ran in " + can.RAN2010.DISTRICT + " in 2010");
							}
						}
					} else {
						n.find('.status').addClass('challenger').text("New Challenger");
					}
					
					$('#right_result .info').append(n);	
				}
				
				if (incumbent_count > 1) {
					$('#right_result').find(".incumbent").text("Multiple districts were combined into this one and the incumbent representatives are challenging each other for the seat!");
				}
					
			}
		});
	  
	  
  	  show_results();
  }
  
  function show_results(distrid) {
	  if (!left_district || !right_district) return;
	  $('.hero-unit .error').hide();
  	  $('.intro-only').hide();
  	  $('.results').show();
  	  $(window).scrollTop($('.results').offset().top - 200);

  	  make_map("left", "2010-cd/" + left_district, "Here is what your current district looks like:");
	  make_map("right", "2012-cd/" + right_district, "Here is what your new 2012 district looks like:");
	  
	  window.location.hash = "#" + $('#address').val().replace(/ +/g, "+");
  }
  
  function make_map(clz, src, descr) {
	// Create a map.
	var myOptions = {
		zoom: 4,
		center: new google.maps.LatLng(38, -96),
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		panControl: false,
		zoomControl: true,
		mapTypeControl: true,
		scaleControl: true,
		streetViewControl: false
		};
		
	var node = $('.' + clz + ' .map_container');
	node.css({ width: node.width(), height: "320px"});
	var map = new google.maps.Map(node[0], myOptions);
	
	$('.' + clz + ' p').text(descr);
	
	// Add a tile overlay for this layer.
	var overlay = new google.maps.ImageMapType({
	  getTileUrl: function(coord, zoom) {
		  return "/map/tiles/" + src + "/" + (zoom-1) + "/" + coord.x + "/" + coord.y + ".png?size=512";
	  },
	  tileSize: new google.maps.Size(512, 512),
	  isPng: true,
	  minZoom: 3,
	  maxZoom: 28,
	  opacity: .85
	});
	map.overlayMapTypes.insertAt(0, overlay);

	$.ajax("/boundaries/" + src,
		{
			success: function(res) {
				if (res && res.extent) {
					var b = new google.maps.LatLngBounds(new google.maps.LatLng(res.extent[1], res.extent[0]), new google.maps.LatLng(res.extent[3], res.extent[2]));
					map.fitBounds(b);
				}
			}
		});
	
	var marker = new google.maps.Marker({
		map: map, 
		position: geocoder_result
	});
	
  }
   
  </script>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/">Your 2012 District</a>
          <div class="nav-collapse">
            <ul class="nav">
              <!--<li class="active"><a href="#">Home</a></li>-->
              <!--<li><a href="#about" onclick="$(window).scrollTo($('#about').offset().top); return false;">About</a></li>-->
              <li><a href="http://www.govtrack.us">GovTrack.us</a></li>
              <li><a href="http://www.civicimpulse.com">Civic Impulse, LLC</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

      <!-- Main hero unit for a primary marketing message or call to action -->
      <div class="hero-unit" style="padding: 30px">
        <h1 style="text-align: center">Find Your 2012 District</h1>
        <div style="margin: 30px auto 0 auto; max-width: 620px;">
        	<p class="intro-only" style="margin-bottom: 1.5em;">Let&rsquo;s find your <b>current</b> congressional district and the congressional district you&rsquo;ll be voting in this <b>November</b>.</p>
        	<p><input id="address" type="text" placeholder="enter your address and then click next" style="width: 100%; height: 36px; font: 28px/32px Verdana,Arial,sans-serif bold;"/></p>
        	<p style="text-align: right"><a class="btn btn-primary btn-large" onclick="go(); return false;">Next &raquo;</a></p>
        	<p class="error" style="display: none; color: red; font-weight: bold;"> </p>
        	<p class="try" style="font-size: 90%">Try:
        		<a href="#" onclick="go($(this).text()); return false;">Des Moines, IA</a> |
        		<a href="#" onclick="go($(this).text()); return false;">Plainview, NY</a> |
        		<a href="#" onclick="go($(this).text()); return false;">Vallejo, CA</a> |
        		<a href="#" onclick="go($(this).text()); return false;">08544</a> |
        		<a href="#" onclick="go($(this).text()); return false;">Tallahassee</a>
        	</p>
        </div>
      </div>

      <!-- Example row of columns -->
      <div class="row results" style="display: none;">
        <div id="left_result" class="span5">
          <h2>In 2010 you voted in...</h2>
          
          <p class="your_district"><span class="dist-state"> </span>-<span class="dist-num"> </span></p>
          
          <div class="info"> </div>
        </div>
        
        <div id="right_result" class="span7">
        <div class="gutter">
          <h2>You&rsquo;ll vote this November in...</h2>
          
          <p class="your_district"><span class="dist-state"> </span>-<span class="dist-num"> </span></p>
          
          <p style="margin: .25em 0 1em 0; text-align: center; color: #F55"> </p>
          
          <div class="info"> </div>
          
          <p class="turbovote">Make sure you&rsquo;re ready to vote by registering to vote on <a href="https://turbovote.org/register/start">TurboVote</a>.</p>
        </div>
        </div>
      </div>

      <div class="row results maps" style="display: none;">
        <div class="span5 left">
          <p> </p>
          <div class="map_container"> </div>
        </div>
        <div class="span7 right">
        <div class="gutter">
          <p> </p>
          <div class="map_container"> </div>
	    </div>
        </div>
      </div>
      
      <hr>

      <footer>
        <p>A project of <a href="http://www.civicimpulse.com">Civic Impulse, LLC</a>.</p>
        <p>Sources:
        	<a href="http://www.srrproject.org/resources/redistricting-shapefiles/">The SRR Project</a>/Brennan Center,
        	<a href="http://www.census.gov/geo/www/tiger/tgrshp2011/tgrshp2011.html">United States Census Bureau</a>,
        	<a href="http://www.opensecrets.org">Center for Responsive Politics</a>,
        	<a href="http://www.fec.gov/finance/disclosure/ftpsum.shtml">Federal Election Commission</a>,
        	<a href="http://www.govtrack.us">GovTrack.us</a>.
        </p>
        <p>Site based on:
        	<a href="https://github.com/tauberer/represent-boundaries">represent-boundaries</a>,
        	<a href="https://github.com/tauberer/boundaries_us">boundaries_us</a>,
        	<a href="https://developers.google.com/maps/documentation/javascript/">Google Maps API</a>,
        	<a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter</a>.
		</p>
      </footer>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/static/bootstrap/js/jquery-1.7.2.min.js"></script>

    <script>
	  $(function() {
		  if (window.location.hash != "" && window.location.hash != "#") {
			  go(window.location.hash.substr(1).replace(/\+/g, " "));
		  }
	  });
	  </script>    
  </body>
</html>

